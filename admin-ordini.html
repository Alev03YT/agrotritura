<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgroTritura • Portale Ordini (Admin)</title>
  <style>
    :root{
      --green:#154c3b;--green2:#0f3b2e;--orange:#f59a00;--bg:#f4f6f7;--card:#ffffff;--border:#e6e6e6;
      --text:#1d1d1f;--muted:#6b7280;--successBg:#e9f8e7;--successBd:#bde5b8;--radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
    .topbar{background:var(--green);color:#fff;padding:22px 16px 16px;border-bottom:6px solid var(--green2);}
    .wrap{max-width:980px;margin:0 auto;padding:0 16px}
    .brand{font-size:34px;font-weight:900;letter-spacing:.2px}
    .brand small{font-weight:700;opacity:.95}
    .subtitle{margin-top:6px;opacity:.95}
    .panel{margin:18px auto 30px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;}
    .sectionTitle{font-size:22px;font-weight:800;color:var(--green);margin:0 0 14px 0;}
    label{display:block;font-weight:700;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:14px 14px;border:2px solid #d6d6d6;border-radius:14px;font-size:18px;outline:none;background:#fff;}
    textarea{resize:vertical;min-height:70px}
    input:focus,select:focus,textarea:focus{border-color:#b7c7c2}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid1{display:grid;grid-template-columns:1fr;gap:14px}
    .actions{display:flex;gap:14px;justify-content:flex-end;align-items:center;margin-top:14px;flex-wrap:wrap}
    .btn{border:none;cursor:pointer;padding:14px 22px;border-radius:14px;font-size:20px;font-weight:900;transition:.15s ease;display:inline-flex;align-items:center;justify-content:center;min-width:220px;}
    .btn.gray{background:#e8e8e8;color:#222;border:2px solid #d4d4d4}
    .btn.gray:hover{filter:brightness(.98)}
    .btn.orange{background:var(--orange);color:#fff;box-shadow:0 6px 18px rgba(245,154,0,.25)}
    .btn.orange:hover{filter:brightness(.97)}
    .statusBox{margin-top:14px;padding:14px 14px;border-radius:14px;border:2px solid transparent;background:#f3f4f6;color:#111;font-weight:700;}
    .ok{background:var(--successBg);border-color:var(--successBd);color:#135d13}
    .err{background:#fde8e8;border-color:#f5b5b5;color:#8a1313}
    .hint{margin-top:10px;color:var(--muted);font-size:15px}
    @media (max-width:820px){.grid2{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="brand">AgroTritura <small>• Portale Ordini (Admin)</small></div>
      <div class="subtitle">Crea un ordine e aggiorna lo stato con pochi tocchi</div>
    </div>
  </div>

  <div class="wrap">

    <div class="panel">
      <h2 class="sectionTitle">1) Crea nuovo ordine / inserisci dati</h2>

      <div class="grid2">
        <div>
          <label for="token">Token admin</label>
          <input id="token" type="password" placeholder="Token admin">
        </div>
        <div>
          <label for="order_id">Codice ordine</label>
          <input id="order_id" placeholder="AT-YYYY-MM-DD-XXXXXX">
        </div>

        <div>
          <label for="customer">Cliente (opzionale)</label>
          <input id="customer" placeholder="Es. Mario B.">
        </div>
        <div>
          <label for="product">Prodotto</label>
          <input id="product" placeholder="Es. Grana verde + Frumento">
        </div>

        <div>
          <label for="quantity">Quantità</label>
          <input id="quantity" placeholder="Es. 25 kg">
        </div>
        <div>
          <label for="status">Stato</label>
          <select id="status">
            <option>Ricevuto</option>
            <option>In lavorazione</option>
            <option>Pronto</option>
            <option>Spedito</option>
            <option>Consegnato</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn gray" id="gen" type="button">Genera codice</button>
        <button class="btn orange" id="saveMain" type="button">Crea/Aggiorna</button>
      </div>

      <div id="msgMain" class="statusBox">⬜ Risultato: in attesa…</div>
    </div>

    <div class="panel">
      <h2 class="sectionTitle">2) Aggiorna stato + aggiungi una nota al cliente</h2>

      <div class="grid2">
        <div>
          <label for="order_id_2">Codice ordine</label>
          <input id="order_id_2" placeholder="AT-...">
        </div>
        <div>
          <label for="status_2">Stato</label>
          <select id="status_2">
            <option>Ricevuto</option>
            <option>In lavorazione</option>
            <option>Pronto</option>
            <option>Spedito</option>
            <option>Consegnato</option>
          </select>
        </div>
      </div>

      <div class="grid1">
        <div>
          <label for="note">Nota al cliente</label>
          <textarea id="note" placeholder="Es. Preparazione in corso — consegna prevista domani pomeriggio"></textarea>
        </div>
      </div>

      <div class="actions">
        <button class="btn orange" id="saveNote" type="button">Salva aggiornamento</button>
      </div>

      <div id="msgNote" class="statusBox">⬜ Risultato: in attesa…</div>
    </div>

    <div class="panel">
      <h2 class="sectionTitle">3) Inserisci link di tracciamento (se spedizione con corriere)</h2>

      <div class="grid2">
        <div>
          <label for="order_id_3">Codice ordine</label>
          <input id="order_id_3" placeholder="AT-...">
        </div>
        <div>
          <label for="status_3">Stato</label>
          <select id="status_3">
            <option>Spedito</option>
            <option>Consegnato</option>
            <option>Pronto</option>
            <option>In lavorazione</option>
            <option>Ricevuto</option>
          </select>
        </div>
      </div>

      <div class="grid1">
        <div>
          <label for="tracking_url">Link tracking</label>
          <input id="tracking_url" placeholder="https://tracking.corriere.it/ABC123">
        </div>
      </div>

      <div class="actions">
        <button class="btn orange" id="saveTracking" type="button">Salva aggiornamento</button>
      </div>

      <div class="hint">ℹ️ Se consegna diretta (tu a domicilio), puoi lasciare vuoto il tracking.</div>
      <div id="msgTrack" class="statusBox">⬜ Risultato: in attesa…</div>
    </div>

  </div>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbwG0K0dgPBVdgS5XogdD_Be_YT6VoCTqQ_pSBBffLxZANaWAIcLmN4g3_MVlFgIujlV/exec";

    function genId(){
      const rand = Math.random().toString(36).slice(2,8).toUpperCase();
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `AT-${y}-${m}-${day}-${rand}`;
    }

    // ✅ FIX: sempre res.text() + JSON.parse protetto (niente più "Unexpected token...")
async function post(payload, msgEl){
  msgEl.className = "statusBox";
  msgEl.textContent = "⏳ Salvataggio…";

  // 1) invia POST (anche se la risposta è bloccata, l’ordine viene salvato)
  try{
    await fetch(API_BASE, {
      method:"POST",
      mode:"no-cors",              // ✅ evita errore “Failed to fetch” quando Google blocca la risposta
      body: new URLSearchParams(payload)
    });
  }catch(e){
    // se anche qui fallisce, allora non arriva proprio al server (ma nel tuo caso salva, quindi raro)
    msgEl.className = "statusBox err";
    msgEl.textContent = "❌ Errore invio: " + e.message;
    return false;
  }

  // 2) conferma leggendo l’ordine via GET (se GET è ok, hai conferma a schermo)
  try{
    const orderId = payload.order_id;
    const res2 = await fetch(`${API_BASE}?order_id=${encodeURIComponent(orderId)}`, { cache:"no-store" });
    const text2 = await res2.text();
    const json2 = JSON.parse(text2);

    if(!json2.ok) throw new Error(json2.error || "Salvato ma non verificabile");
    msgEl.className = "statusBox ok";
    msgEl.textContent = `✅ Salvato! (confermato) • Aggiornato: ${json2.order.updated_at || ""}`;
    return true;
  }catch(e){
    // Se GET è bloccato da CORS, almeno non rompi tutto: hai già salvato.
    msgEl.className = "statusBox ok";
    msgEl.textContent = "✅ Salvato! (ma conferma non disponibile dal browser)";
    return true;
  }
}

    document.getElementById("gen").addEventListener("click", ()=>{
      const id = genId();
      document.getElementById("order_id").value = id;
      document.getElementById("order_id_2").value = id;
      document.getElementById("order_id_3").value = id;
    });

    document.getElementById("saveMain").addEventListener("click", ()=>{
      const payload = {
        token: document.getElementById("token").value.trim(),
        order_id: document.getElementById("order_id").value.trim(),
        customer: document.getElementById("customer").value.trim(),
        product: document.getElementById("product").value.trim(),
        quantity: document.getElementById("quantity").value.trim(),
        status: document.getElementById("status").value,
        tracking_url: "",
        note: ""
      };

      document.getElementById("order_id_2").value = payload.order_id;
      document.getElementById("order_id_3").value = payload.order_id;
      document.getElementById("status_2").value = payload.status;
      document.getElementById("status_3").value = payload.status;

      post(payload, document.getElementById("msgMain"));
    });

    document.getElementById("saveNote").addEventListener("click", ()=>{
      const payload = {
        token: document.getElementById("token").value.trim(),
        order_id: document.getElementById("order_id_2").value.trim(),
        status: document.getElementById("status_2").value,
        note: document.getElementById("note").value.trim()
      };
      post(payload, document.getElementById("msgNote"));
    });

    document.getElementById("saveTracking").addEventListener("click", ()=>{
      const payload = {
        token: document.getElementById("token").value.trim(),
        order_id: document.getElementById("order_id_3").value.trim(),
        status: document.getElementById("status_3").value,
        tracking_url: document.getElementById("tracking_url").value.trim()
      };
      post(payload, document.getElementById("msgTrack"));
    });
  </script>
</body>
</html>
